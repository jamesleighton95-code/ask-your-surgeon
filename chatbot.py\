# chatbot.py
import os
from langchain_openai import OpenAI, OpenAIEmbeddings
from langchain.chains import RetrievalQA
from langchain_community.vectorstores import FAISS
from langchain.prompts import PromptTemplate

# Make sure API key is available
assert "OPENAI_API_KEY" in os.environ, "Please set OPENAI_API_KEY"

# Load FAISS index
embeddings = OpenAIEmbeddings()
db = FAISS.load_local(
    "embeddings/prostate_cancer_index",
    embeddings,
    allow_dangerous_deserialization=True
)

# Limit retrieved chunks
retriever = db.as_retriever(search_kwargs={"k": 3})

# Patient-friendly system prompt
prompt_template = """You are a helpful urology surgeon assistant.
Answer the following question in simple, clear language a patient can understand.
Use the following context from trusted guidelines and resources to support your answer.

Context:
{context}

Question: {question}
Helpful Answer:"""

PROMPT = PromptTemplate(template=prompt_template, input_variables=["context", "question"])

qa_chain = RetrievalQA.from_chain_type(
    llm=OpenAI(temperature=0),
    retriever=retriever,
    chain_type_kwargs={"prompt": PROMPT},
    return_source_documents=True,
)

